## 🧭 アーキテクチャ図（Architecture Overview）

要件定義書・概要設計書の内容を踏まえたシステム全体像です。まずは MVP（ローカル/PWA、ログインなし）の構成を示し、将来の Firebase 連携構成も併記します。

### 1. MVP ローカル構成図（PWA）

```mermaid
flowchart LR
  subgraph クライアント
    P[親 UI]
    C[子 UI 1ボタン]
  end

  subgraph ローカル
    IDB[IndexedDB]
    LS[LocalStorage]
    SW[Service Worker]
  end

  P <--> IDB
  C <--> IDB
  P --> LS
  C --> LS
  SW --- IDB
```

---

### 2. MVP シーケンス図（ローカル）

#### A. 子: 開始と終了（ローカル計測）

```mermaid
sequenceDiagram
  autonumber
  participant C as 子UI
  participant IDB as ローカルDB
  participant LS as 設定

  Note over C: 残りが0分なら開始不可

  C->>IDB: startTimestamp を保存
  C-->>C: 画面に経過を表示
  ... 経過 ...
  C->>IDB: end で startTimestamp を読み込み
  C-->>C: 経過分を分に丸めて減算
  C->>IDB: remainingMinutes を更新
  C-->>C: 残り時間を再表示
```

#### B. 親: 付与・リセット・バックアップ

```mermaid
sequenceDiagram
  autonumber
  participant P as 親UI
  participant IDB as ローカルDB
  participant FS as ファイル

  P->>IDB: +5 / +10 / +15 を加算
  P->>IDB: リセットで 0 に更新（確認）
  P->>FS: JSON にエクスポート
  P->>IDB: JSON インポートで上書き
```

#### C. 子: 追加時間の申請と承認

```mermaid
sequenceDiagram
  autonumber
  participant C as 子UI
  participant P as 親UI
  participant IDB as ローカルDB

  C->>IDB: grant_requests に pending を作成（+5 など）
  alt 自動承認ON
    IDB-->>C: 申請作成と同時に残高へ反映（approved）
  else 承認必須
    P->>IDB: 承認操作（approved/rejected）
    IDB-->>C: 承認なら残高へ反映
  end
```

---

### 3. MVP セキュリティと整合性

- 親モードは PIN ロック、複数回失敗でクールダウン（任意）
- 子の終了操作は長押しまたは確認で誤操作防止
- 連続セッション最大長で暴走防止、1分単位で丸め
- iPad Safari 運用: プライベートブラウズ回避、PWAとSafariはどちらかに統一
- データ保全: 定期JSONバックアップを推奨

---

### 4. 将来構成図（Firebase 連携）

```mermaid
flowchart LR
  subgraph クライアント
    P[親アプリ]
    C[子供アプリ]
  end

  subgraph Firebase バックエンド
    AUTH[Firebase Auth]
    RULES[Firestore Rules]
    DB[(Cloud Firestore\nusers / usage_logs)]
    FUNC[Cloud Functions]
  end

  P --> AUTH
  C --> AUTH
  P <--> DB
  C <--> DB
  DB --> RULES
  DB --> FUNC
  FUNC --> DB
```

### 5. 将来: クラウド連携の考慮

- 認証と権限制御: 親子ロールを区別
- 同期と一貫性: Functions で時間加減算を集中管理
- セキュリティ: Rules で不正書き込みを防止、型と範囲を検証
