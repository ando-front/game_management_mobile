# バグ修正履歴

## 2025年10月5日

### Bug #001: PIN入力成功後に親管理画面に遷移しない

**発生箇所**: App.tsx - 画面遷移ロジック

**症状**:
- 子供用ホーム画面で「親モード →」をクリック
- PIN入力画面が表示される
- 正しいPIN「0000」を入力して「開く」をクリック
- **期待**: 親管理画面に遷移
- **実際**: PIN入力画面のまま、または子供用ホームに戻る

**原因**:
App.tsxの親モード遷移フローに問題があった：

1. `ChildHome.tsx`で「親モード →」クリック時に`useAppStore.setState({ isParentMode: true })`を直接呼び出し
2. App.tsxのuseEffectが`isParentMode`の変化を監視して`showPinInput`を`true`に設定
3. PIN入力成功後、`handlePinSuccess`で`showPinInput`を`false`に設定
4. **問題**: useEffectが`isParentMode && !showPinInput`を検知して再度`showPinInput`を`true`に戻してしまう

```typescript
// 問題のあったコード
React.useEffect(() => {
  if (isParentMode && !showPinInput) {
    setShowPinInput(true);  // ← これが無限ループの原因
  }
}, [isParentMode, showPinInput]);
```

**修正内容**:

#### 1. ChildHome.tsx
`isParentMode`を直接設定する代わりに、カスタムイベントを発火するように変更：

```typescript
// 修正前
const handleParentMode = () => {
  useAppStore.setState({ isParentMode: true });
};

// 修正後
const handleParentMode = () => {
  window.dispatchEvent(new CustomEvent('requestParentMode'));
};
```

#### 2. App.tsx
useEffectを削除し、カスタムイベントリスナーを追加：

```typescript
// 修正前
React.useEffect(() => {
  if (isParentMode && !showPinInput) {
    setShowPinInput(true);
  }
}, [isParentMode, showPinInput]);

// 修正後
React.useEffect(() => {
  const handleRequestParentMode = () => {
    setShowPinInput(true);
  };

  window.addEventListener('requestParentMode', handleRequestParentMode);
  return () => {
    window.removeEventListener('requestParentMode', handleRequestParentMode);
  };
}, []);
```

**修正後のフロー**:
1. 子供モードで「親モード →」クリック → `requestParentMode`イベント発火
2. App.tsxでイベント受信 → `showPinInput = true`
3. PinInput画面表示
4. PIN入力成功 → `enterParentMode(pin)`でストア内の`isParentMode = true`
5. `onSuccess()`コールバック → `showPinInput = false`
6. レンダリング条件: `showPinInput=false && isParentMode=true` → **ParentPanel表示**

**テスト結果**:
- ✅ ビルド成功（TypeScriptエラー0件）
- ⏳ ブラウザでの動作確認待ち

**影響範囲**:
- App.tsx
- components/child/ChildHome.tsx

**関連ファイル**:
- [src/App.tsx](../src/App.tsx)
- [src/components/child/ChildHome.tsx](../src/components/child/ChildHome.tsx)
- [src/components/parent/PinInput.tsx](../src/components/parent/PinInput.tsx)

---

## 2025年10月5日（追加修正）

### Bug #002: PIN入力画面で「開く」ボタンを押しても反応しない

**発生箇所**: PinInput.tsx、PinSettings.tsx - ボタンのonClickハンドラー

**症状**:
- PIN入力画面で「0000」を入力
- 「開く」ボタンをクリック
- **期待**: 親管理画面に遷移
- **実際**: 何も反応しない

**原因**:
`Button`コンポーネントの`onClick`に渡していた関数が不適切：

```typescript
// 問題のあったコード
<Button size="large" onClick={() => handleSubmit({} as React.FormEvent)}>
  開く
</Button>
```

問題点：
1. `handleSubmit`は`React.FormEvent`を引数に取り、`e.preventDefault()`を呼び出す
2. しかし`{} as React.FormEvent`は空オブジェクトで、`preventDefault`メソッドが存在しない
3. 実行時エラーが発生し、ボタンが機能しない

**修正内容**:

#### 1. PinInput.tsx
`handleSubmit`から`preventDefault()`呼び出しを除いた専用の関数を作成：

```typescript
// 修正後
const handleButtonClick = () => {
  // ロック中チェック
  if (pinLockedUntil > 0 && Date.now() < pinLockedUntil) {
    return;
  }

  if (!validatePin(pin)) {
    setLocalError('4桁の数字を入力してください');
    return;
  }

  const success = enterParentMode(pin);
  if (success) {
    setPin('');
    onSuccess();
  }
};

// ボタンで使用
<Button size="large" onClick={handleButtonClick}>
  開く
</Button>
```

#### 2. PinSettings.tsx
同様の問題があったため、同じパターンで修正：

```typescript
const handleButtonClick = async () => {
  // handleSubmitのロジックをコピー（preventDefault除く）
  // ...
};

<Button onClick={handleButtonClick}>
  変更する
</Button>
```

**テスト結果**:
- ✅ ビルド成功（TypeScriptエラー0件）
- ⏳ ブラウザでの動作確認待ち

**影響範囲**:
- components/parent/PinInput.tsx
- components/parent/PinSettings.tsx

**関連ファイル**:
- [src/components/parent/PinInput.tsx](../src/components/parent/PinInput.tsx)
- [src/components/parent/PinSettings.tsx](../src/components/parent/PinSettings.tsx)
- [src/components/common/Button.tsx](../src/components/common/Button.tsx)

**補足**:
この問題はBug #001の修正時に導入されたリグレッションです。型アサーション`{} as React.FormEvent`を使用したことで、TypeScriptのコンパイル時には通過しましたが、実行時にエラーが発生していました。

---

## テンプレート（今後のバグ記録用）

### Bug #XXX: [バグのタイトル]

**発生箇所**: ファイル名 - 関数/コンポーネント名

**症状**:
- 再現手順1
- 再現手順2
- **期待**: 期待される動作
- **実際**: 実際の動作

**原因**:
問題の根本原因を説明

**修正内容**:
どのように修正したか

**テスト結果**:
- [ ] 修正確認
- [ ] リグレッションテスト

**影響範囲**:
変更したファイルのリスト

**関連ファイル**:
- [ファイル1](../path/to/file1)
- [ファイル2](../path/to/file2)
