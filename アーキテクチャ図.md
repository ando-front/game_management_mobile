## 🧭 アーキテクチャ図（Architecture Overview）

要件定義書・概要設計書の内容を踏まえたシステム全体像です。クライアント（親/子）と Firebase バックエンド（Auth / Firestore / Cloud Functions）を中心に、権限制御と時間計測の整合性確保を示しています。

```mermaid
flowchart LR
  %% クライアント層
  subgraph Clients[クライアント]
    P[親アプリ (iOS / Android / Web)]
    C[子供アプリ (iOS / Android / Web)]
  end

  %% バックエンド層（Firebase）
  subgraph FB[Firebase バックエンド]
    AUTH[Firebase Auth\n(親/子ロール)]
    RULES[Firestore Security Rules\n(権限/検証)]
    DB[(Cloud Firestore\nusers / tasks / usage_logs)]
    FUNC[Cloud Functions\n(HTTP/Callable/Triggers)]
  end

  %% Cloud Functions 内の主な役割
  subgraph FN[業務ロジック（Functions 詳細）]
    F1[タスク承認ハンドラ\n(onUpdate tasks)]
    F2[時間残高更新器\n(onCreate usage_logs, onUpdate tasks)]
    F3[整合性バリデータ\n(サーバ時刻/上限/改ざん検知)]
  end

  %% 認証・権限
  P -->|ログイン| AUTH
  C -->|ログイン| AUTH

  %% データアクセス（リアルタイム購読/書き込み）
  P <-->|SDK 読み書き/購読| DB
  C <-->|SDK 読み書き/購読| DB
  DB --> RULES
  RULES -. 許可/拒否 .-> DB

  %% 変更トリガとサーバサイド更新
  DB -->|変更トリガ| FUNC
  FUNC --- F1
  FUNC --- F2
  FUNC --- F3
  F1 --> DB
  F2 --> DB
  F3 --> DB

  %% 代表的なデータフロー注記
  classDef note fill:#f9f9f9,stroke:#bbb,color:#333;
  class AUTH,RULES,DB,FUNC,F1,F2,F3 note;
```

### 図の意図

- 認証: 親/子ユーザーは `Firebase Auth` によりログインし、`role` に応じたアクセス権を付与。
- 権限制御: `Firestore Security Rules` がクライアント直書きを制御。親のみ特定操作許可、子は自身ドキュメントに限定。
- データモデル: `users` / `tasks` / `usage_logs` を中心に、リアルタイム購読で UI を即時反映。
- 業務ロジック: `Cloud Functions` が時間残高計算・タスク承認・不正抑止（サーバ時刻基準や上限）を担い、改ざんに強い設計。

### 主要コンポーネントの補足

- 親アプリ
  - タスク登録/編集、進捗の承認、時間付与/リセット。
- 子供アプリ
  - 残り時間の表示、ゲーム開始/終了、タスク完了申請。
- Cloud Functions 例
  - タスク承認ハンドラ: `tasks.status` 変更時に `approved` へ遷移を検証。
  - 時間残高更新器: `usage_logs` 生成/確定時に `users.gameMinutes` を増減。
  - 整合性バリデータ: クライアント送信値に上限/サーバ時刻基準を適用。

必要があれば、画面遷移やユースケース別のシーケンス図も追補できます。

